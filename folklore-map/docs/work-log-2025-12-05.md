## 2025-12-05 全国古地図対応とCSP修正ログ

### 実施内容
- spot-map.tsx に全国16地域の自動/手動選択を実装  
  - regionMode 追加（auto/manual）、bounds_changed を 200ms デバウンスして自動判定  
  - 地域ドロップダウンと「自動判定に戻す」ボタンを追加  
  - 透明度スライダーと地域表示を統合、ズーム不足時は自動で10まで引き上げ  
  - デバッグ表示に地域名・透明度・自動/手動状態を明示
- ktgis タイル許可のため CSP を修正  
  - middleware.ts の img-src / connect-src に `https://ktgis.net` / `https://*.ktgis.net` を追加  
  - 開発時の HMR 用 ws (localhost/0.0.0.0/127.0.0.1/192.168.0.238) を connect-src に許可
- Next 設定を mjs 化し、allowedDevOrigins を LAN/localhost で常時許可（next.config.mjs）
- dev サーバー再起動済み（PID は作業時点 123377）
- Spot API/フロントの上限拡大  
  - `/api/spots` のデフォルト limit を 100 → 2000 に拡大  
  - トップページ `src/app/page.tsx` の初期取得件数を 100 → 2000 に拡大し、表示文言を「全国180件超」に更新  
  - データ投入（seed-data-100 + import-new-folklore）後の総件数は 180 件を確認
- scripts/import-new-folklore.ts を追加し、new-folklore-data.json（16件）をDBに投入できるようにした  
  - 既存タイトル重複はスキップ  
  - 新規アドレスのモック座標を追加（瀬戸内市牛窓、飯塚市、天理市、阿賀町津川、佐渡市など）

### 確認・テスト
- Node で各地域タイルの HEAD チェックを実施（期別 00 が 200 になることを確認）  
- ブラウザでハードリロード後、「明治期古地図」表示と地域切替を確認（ユーザー側で最終確認を依頼中）
- 自動テスト（lint/test）は未実行

### 残課題 / メモ
- ブラウザ側でまだ表示されない場合は Google Maps API キーのリファラ制限とブラウザコンソールエラーを要確認  
- Next の allowedDevOrigins 警告が残る場合はキャッシュクリア/シークレットまたは再起動で解消を試す  
- 沖縄等でデータ未提供の場合のフォールバック（例: 首都圏タイルや案内メッセージ）は未実装
- スポット一覧が100件で止まる場合は、ブラウザキャッシュをクリアして再読込。API/フロントとも上限は 2000 に設定済み。
