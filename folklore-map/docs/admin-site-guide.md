# 管理者サイトガイド

## 概要

民俗学マップの管理者専用サイトが実装されました。このサイトでは、スポットの管理、通報の処理、システム統計の確認など、管理者向けの機能を簡単に利用できます。

---

## アクセス方法

### URL
```
http://localhost:3000/admin
```

開発サーバーを起動後、ブラウザで上記URLにアクセスしてください。

### 必要な権限
管理者サイトの利用には **admin** または **reviewer** 権限が必要です。

---

## 主要機能

### 1. ダッシュボード (`/admin`)

システム全体の統計と最近の活動を一目で確認できます。

**表示される情報:**
- 総スポット数
- 公開中のスポット数
- 総通報数と未処理通報数
- ステータス別スポット数（下書き/レビュー中/公開）
- アイコン種別ごとの分布
- 最近追加されたスポット（5件）
- 最近の通報（5件）

**統計カード:**
- 📍 総スポット数
- ✅ 公開中
- 🚩 総通報数
- ⚠️ 未処理通報

**グラフ・一覧:**
- ステータス別スポット数
- アイコン種別（上位5つ）
- 最近のスポット（タイトル、ステータス、作成日時）
- 最近の通報（スポット名、理由、ステータス、通報日時）

---

### 2. スポット管理 (`/admin/spots`)

全スポットの一覧表示と管理が可能です。

**機能:**

#### 検索・フィルタ
- **テキスト検索**: タイトルや説明文で検索
- **ステータスフィルタ**: すべて/下書き/レビュー中/公開
- **アイコン種別フィルタ**: すべて/鬼/狐/犬/龍/寺/神社/動物/その他

#### 一覧表示
テーブル形式で以下の情報を表示:
- チェックボックス（複数選択用）
- タイトルと説明（抜粋）
- アイコン種別
- ステータス（色分け表示）
- 住所
- 作成日

#### 削除機能
1. **個別削除**: 各行の「削除」ボタン
   - クリック時に確認ダイアログを表示
   - スポット名を表示して誤操作を防止
   - 「この操作は取り消せません」と警告

2. **一括削除**: 複数選択して削除
   - チェックボックスで削除対象を選択
   - ヘッダーのチェックボックスで全選択/全解除
   - 「選択した N 件を削除」ボタンで一括削除
   - 確認ダイアログで再確認

**表示件数:**
最大 1000 件まで取得可能（デフォルト: 100件）

---

### 3. 通報管理 (`/admin/flags`)

ユーザーからの通報を確認・処理できます。

**機能:**

#### フィルタボタン
- **未処理**: 対応が必要な通報のみ表示
- **処理済み**: 対応完了した通報のみ表示
- **すべて**: 全通報を表示

#### 一覧表示
- スポット名
- 通報理由（不適切/誤情報/差別/プライバシー）
- 詳細メモ（抜粋）
- ステータス（未処理/処理済み）
- 通報日時

#### 詳細モーダル
各通報の「詳細」ボタンをクリックすると、詳細情報を表示:
- スポット名
- 通報理由
- 詳細メモ（全文）
- 通報日時
- 現在のステータス

**処理アクション:**
- 処理コメント入力（任意）
- 「処理済みにする」ボタンでステータスを CLOSED に変更
- 処理後は一覧に自動反映

---

### 4. ユーザー管理 (`/admin/users`)

**現在の状態:** プレースホルダーページ（実装予定）

**計画されている機能:**
- ユーザー一覧の表示
- ロール（権限）の変更
- ユーザーの有効化/無効化
- ユーザーアクティビティログの閲覧
- アカウント作成日時と最終ログイン情報

---

## 技術仕様

### ページ構成

```
/admin
├── page.tsx              # ダッシュボード
├── spots/
│   └── page.tsx          # スポット管理
├── flags/
│   └── page.tsx          # 通報管理
└── users/
    └── page.tsx          # ユーザー管理（予定）
```

### コンポーネント

**`AdminLayout` (`src/components/admin-layout.tsx`)**
- 管理者サイト共通レイアウト
- サイドバーナビゲーション
- ヘッダー（「ユーザーサイトへ」リンク付き）

### API エンドポイント

#### 統計取得
```
GET /api/admin/stats
```
管理者権限が必要。システム全体の統計を返す。

**レスポンス:**
```json
{
  "spots": {
    "total": 88,
    "byStatus": { "PUBLISHED": 88, "DRAFT": 0, "REVIEW": 0 },
    "byIcon": { "SHRINE": 35, "GENERIC": 31, ... }
  },
  "flags": {
    "total": 0,
    "open": 0,
    "byReason": {}
  },
  "recent": {
    "spots": [...],
    "flags": [...]
  }
}
```

#### スポット一覧（拡張版）
```
GET /api/spots?status=all&limit=1000
```
管理者権限の場合、詳細情報（description, address, created_at, created_by）を含む。

**クエリパラメータ:**
- `status`: `all`, `DRAFT`, `REVIEW`, `PUBLISHED`
- `limit`: 取得件数（最大 1000）
- `q`: テキスト検索
- `bbox`: 地理範囲フィルタ

#### スポット削除
```
DELETE /api/spots/:id
```
管理者権限が必要。指定されたスポットを削除（関連する Source, Flag も自動削除）。

#### 通報一覧
```
GET /api/flags
```
reviewer権限以上が必要。

#### 通報処理
```
PATCH /api/flags/:id
```
reviewer権限以上が必要。ステータスを CLOSED に変更し、処理コメントを記録。

---

## UI/UX の特徴

### デザイン
- **モダンなカード UI**: 白背景、影付き、角丸
- **色分けステータス**:
  - 🟢 公開: 緑色
  - 🟡 レビュー中: 黄色
  - ⚫ 下書き: グレー
  - 🔴 未処理通報: 赤色

### ナビゲーション
- 左サイドバーで主要機能にアクセス
- アクティブページは青色でハイライト
- アイコン付きで視認性向上

### レスポンシブ対応
- デスクトップ優先設計
- グリッドレイアウトで柔軟に配置
- 小画面でも使いやすいUI

### 安全機能
- 削除時は必ず確認ダイアログ
- 「この操作は取り消せません」という警告文
- スポット名/件数を明示して誤操作防止

---

## 使用例

### シナリオ1: 不適切なスポットを削除
1. `/admin/spots` にアクセス
2. 検索バーで問題のスポットを検索
3. 該当行の「削除」ボタンをクリック
4. 確認ダイアログで「削除」を選択
5. スポットが削除され、一覧から消える

### シナリオ2: 複数のスポットを一括削除
1. `/admin/spots` にアクセス
2. フィルタで削除対象を絞り込み
3. チェックボックスで削除したいスポットを選択
4. 「選択した N 件を削除」ボタンをクリック
5. 確認後、一括削除実行

### シナリオ3: 通報を処理
1. `/admin/flags` にアクセス
2. 「未処理」フィルタで未対応の通報のみ表示
3. 該当通報の「詳細」ボタンをクリック
4. 詳細を確認し、必要に応じてスポットを修正/削除
5. 処理コメント入力（任意）
6. 「処理済みにする」ボタンをクリック
7. 通報がクローズされる

### シナリオ4: システム全体の状況確認
1. `/admin` にアクセス
2. ダッシュボードで以下を確認:
   - 総スポット数と公開数
   - 未処理通報の有無
   - 最近の活動状況
3. 必要に応じて各管理ページに移動

---

## 権限設定

### 必要な権限レベル

| ページ/機能 | 必要な権限 |
|------------|-----------|
| ダッシュボード | admin |
| スポット管理 | admin |
| スポット削除 | admin |
| 通報管理 | reviewer以上 |
| 通報処理 | reviewer以上 |
| ユーザー管理 | admin（実装予定） |

### 権限の確認方法
`lib/auth.ts` の `getUserRole()` と `hasRole()` を使用して権限チェックを実施。

---

## セキュリティ

### 実装済みの保護機能
1. **API レベルの権限チェック**
   - すべての管理者APIで権限確認
   - 不正アクセスは 403 Forbidden を返す

2. **確認ダイアログ**
   - 削除操作は必ず確認が必要
   - スポット名を表示して誤操作防止

3. **RLS (Row Level Security)**
   - データベースレベルでアクセス制御
   - Supabase RLS ポリシーを使用

### 今後の強化予定
- CSRF トークン
- 操作ログの記録（Audit テーブル）
- IP アドレス制限（管理者専用ネットワーク）

---

## トラブルシューティング

### エラー: 「管理者権限が必要です」
**原因:** ログインユーザーが admin 権限を持っていない

**解決方法:**
1. Supabase Dashboard でユーザーの `app_metadata.role` を確認
2. `admin` または `reviewer` に設定
3. 再ログイン

### エラー: 「統計の取得に失敗しました」
**原因:** データベース接続エラーまたは権限不足

**解決方法:**
1. データベースが起動しているか確認（`supabase status`）
2. `DATABASE_URL` 環境変数が正しいか確認
3. ブラウザのコンソールでエラー詳細を確認

### スポットが削除されない
**原因:** API リクエストが失敗している

**解決方法:**
1. ブラウザの開発者ツールでネットワークタブを確認
2. エラーレスポンスの内容を確認
3. 該当スポットが存在するか確認（`/api/spots/:id` で GET）

---

## 今後の拡張予定

### 短期（次のスプリント）
- [ ] ユーザー管理機能の実装
- [ ] スポット編集機能（インライン編集）
- [ ] 一括ステータス変更（DRAFT → PUBLISHED など）
- [ ] エクスポート機能（CSV, JSON）

### 中期
- [ ] 操作ログビューアー
- [ ] グラフとチャート（時系列の投稿数など）
- [ ] 高度な検索（複数条件、正規表現）
- [ ] バックアップ・復元機能

### 長期
- [ ] AI 支援の不適切コンテンツ検出
- [ ] 自動モデレーション
- [ ] マルチテナント対応

---

## 関連ドキュメント

- **プロジェクト概要**: `CLAUDE.md`
- **API 設計**: `api_design.md`
- **データベース設計**: `db_design.md`
- **認証と認可**: `lib/auth.ts`
- **民俗学データ更新ログ**: `docs/folklore-data-update-log.md`

---

## 更新履歴

### 2025-11-09
- 管理者サイト初版リリース
- ダッシュボード、スポット管理、通報管理を実装
- 統計 API エンドポイント追加
- AdminLayout コンポーネント作成
- 削除機能（個別・一括）実装
